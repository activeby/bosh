#!/usr/bin/env ruby

# Copyright (c) 2012 Active Technologies, Inc.

# Usage example:
#      $ cd /bosh-installation-dir/bosh/cloudstack_cpi/bin
#      $ ruby bosh_cloudstack_console -c /path-to-file/cloudstack_cpi_secure_config.yml

# Put your access credentials securely in separate file.
# contents of the file cloudstack_cpi_secure_config.yml:
# ---
# access_key_id: key
# secret_access_key: key
# service_endpoint: domain


require 'yaml'
require "optparse"

config_file = File.expand_path("../cloudstack.yaml", __FILE__)

opts_parser = OptionParser.new do |opts|
  opts.on("-c", "--config FILE") { |file| config_file = file }
end

opts_parser.parse!

unless config_file
  puts opts_parser
  exit(1)
end

puts "=> Loading secure configuration from #{config_file}"

def get_config_options(config)
  @access_key_id = config["access_key_id"]
  @secret_access_key = config["secret_access_key"]
  @service_endpoint = config["service_endpoint"]
end

get_config_options(YAML.load(File.read(config_file)))

puts "=> CloudStack service endpoint is #{@service_endpoint}"

puts "=> Performing test operations with cloudstack_cpi code"

#### TESTS ####

require "../../cli/lib/cli"

$:.unshift(File.expand_path("../../lib", __FILE__))

require "../lib/bosh_cloudstack_cpi"

cld = Bosh::CloudStackCloud::Cloud.new({
                                           'cloudstack' => {
                                               'cloudstack_api_key' => "#{@access_key_id}",
                                               'cloudstack_secret_access_key' => "#{@secret_access_key}",
                                               'cloudstack_host' => "#{@service_endpoint}"
                                           }
                                       })

cld.create_stemcell "image", {}